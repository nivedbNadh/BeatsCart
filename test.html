const editform = function(req, res) {
    const productId = req.params.id;
    Promise.all([
        Product.findById(productId),
        Category.find({})
    ])
    .then(([product, categories]) => {
        res.render('./product/editproduct', { product, categories });
    })
    .catch(err => {
        console.error(err);
        res.status(500).send('Internal Server Error');
    });
};

//Update product--------------------------------
const updateproduct = async function (req, res) {
    const productId = req.params.id;
    const { name, description, category, price, quantity } = req.body;
    const deleteExistingImages = req.body;
    const newImages = req.files;

    try {
        const currentProduct = await Product.findById(productId);
        if (!currentProduct) {
            return res.status(404).send('Product not found');
        }
        for (const key in deleteExistingImages) {
            if (key.startsWith('deleteExistingImage')) {
                const index = parseInt(key.replace('deleteExistingImage', ''));
                const imageFilename = deleteExistingImages[key];
                const imagePath = path.join(__dirname, '../public/assets/product-images', imageFilename);
                
                await FS.promises.unlink(imagePath);
                console.log('Image Deleted Successfully:', imageFilename);
                
                currentProduct.images.splice(index, 1);
                
                await Product.deleteOne({ filename: imageFilename });
                console.log('Image deleted from the database:', imageFilename);
            }
        }

        if (newImages && newImages.length > 0) {
            newImages.forEach(async (image) => {
                const imageFilename = image.filename;
                currentProduct.images.push(imageFilename);
                console.log('New image added:', imageFilename);
            });
        }
        currentProduct.name = name;
        currentProduct.description = description;
        currentProduct.category = category;
        currentProduct.price = price;
        currentProduct.quantity = quantity;

        await currentProduct.save();
        res.redirect('/product');
    } catch (err) {
        console.error(err);
        res.status(500).send('Internal Server Error');
    }
};



